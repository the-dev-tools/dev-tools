# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: '3'

output: prefixed

tasks:
  default:
    interactive: true
    silent: true
    cmd: task --list --sort=none --output=interleaved

  dev:desktop:
    desc: Start desktop app development servers
    interactive: true
    env:
      LOG_LEVEL: INFO
    cmd: nx run desktop:dev {{.CLI_ARGS}}

  dev:desktop:auth:
    desc: Start desktop app with BetterAuth authentication
    interactive: true
    env:
      LOG_LEVEL: INFO
      AUTH_MODE: betterauth
      AUTH_SECRET: dev-secret-do-not-use-in-production
      BETTERAUTH_URL: http://localhost:50051
    cmd: nx run-many --targets=dev --projects=betterauth,server,desktop {{.CLI_ARGS}}

  lint:
    desc: Check code for common problems
    interactive: true
    cmd: pnpm nx run-many --targets=lint --targets=lint:format --nxBail {{.CLI_ARGS}}

  test:
    desc: Test code for common problems (fast, local development)
    interactive: true
    cmd: pnpm nx run-many --targets=test {{.CLI_ARGS}}

  test:ci:
    desc: Test code with JSON output for CI
    interactive: true
    cmd: pnpm nx run-many --targets=test:ci {{.CLI_ARGS}}

  fix:
    desc: Automatically fix common problems
    deps:
      - fix:prettier
      - fix:syncpack

  fix:prettier:
    cmd: pnpm prettier --write .

  fix:syncpack:
    deps:
      - fix:syncpack:format
      - fix:syncpack:mismatches

  fix:syncpack:format:
    cmd: pnpm syncpack format

  fix:syncpack:mismatches:
    cmds:
      - pnpm syncpack fix-mismatches
      - pnpm install

  update:
    desc: Update project dependencies
    deps:
      - update:flake
      - update:pnpm

  update:flake:
    cmd: nix flake update

  update:pnpm:
    interactive: true
    cmds:
      - aikido-pnpm update --recursive --interactive --latest
      - task: fix:syncpack:mismatches

  storybook:
    desc: Start the Storybook composition
    interactive: true
    cmd: nx run storybook:storybook

  version-plan:
    interactive: true
    desc: Create a version plan for the specified project
    requires:
      vars:
        - name: project
          enum: [api-recorder-extension, desktop, cli]
    cmd: nx release plan --onlyTouched=false --projects={{.project}}

  benchmark:run:
    desc: Run benchmarks (standard go test)
    cmds:
      - mkdir -p .bench
      - go test -bench=. -benchmem -run=^$ -count=3 -timeout=30m ./packages/server/... ./packages/db/... ./apps/cli/... | tee .bench/current.txt
      - go run tools/benchmark/*.go parse --input .bench/current.txt --output .bench/current.json

  benchmark:baseline:
    desc: Run benchmarks and save as baseline
    cmds:
      - mkdir -p .bench
      - go test -bench=. -benchmem -run=^$ -count=3 -timeout=30m ./packages/server/... ./packages/db/... ./apps/cli/... | tee .bench/baseline.txt
      - go run tools/benchmark/*.go parse --input .bench/baseline.txt --output .bench/baseline.json

  benchmark:compare:
    desc: Compare current results with baseline
    cmds:
      - go run tools/benchmark/*.go compare --baseline .bench/baseline.txt --current .bench/current.txt --output-json .bench/comparison.json --output-md .bench/comparison.md
